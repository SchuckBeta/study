----------------------------------------------------------------------------------------------
Activitå·¥ä½œæµè°ƒç ”
----------------------------------------------------------------------------------------------
å‰è¨€ï¼š
	1ã€å·¥ä½œæµæ•´åˆåŸºäºJeesiteé¡¹ç›®ï¼š
		aã€ç›®å½•ç»“æ„ï¼Ÿ
		bã€ç›®å½•è¯¦è§£ï¼Ÿ
	2ã€å·¥ä½œæµæµç¨‹æ¥å£ï¼š
		aã€ç›®å½•ç»“æ„ï¼Ÿ


æ­£æ–‡ï¼š
	1ã€å·¥ä½œæµæ•´åˆåŸºäºJeesiteé¡¹ç›®ï¼š
		aã€ç›®å½•ç»“æ„ï¼š
			åå°ï¼š
				æµç¨‹ç›®å½•:
					\src\main\java\com\oseasy\initiate\modules\act
					\src\main\java\com\oseasy\initiate\modules\act\web\ActModelController.java
					\src\main\java\com\oseasy\initiate\modules\act\rest\editor\model\ModelSaveRestResource.java
					
				æµç¨‹Restæ¥å£èµ„æºç›®å½•:
					\src\main\java\com\oseasy\initiate\modules\act\rest
					\src\main\java\com\oseasy\initiate\modules\act\rest\editor\model\ModelEditorJsonRestResource.java
					\src\main\java\com\oseasy\initiate\modules\act\rest\editor\model\ModelSaveRestResource.java
					\src\main\java\com\oseasy\initiate\modules\act\rest\editor\main\StencilsetRestResource.java

			å‰å°ï¼š
				æµç¨‹ç¼–è¾‘å™¨ç›®å½•:
					\src\main\webapp\act\process-editor\editor-app
				æµç¨‹ç¼–è¾‘å™¨å…¥å£æ–‡ä»¶:
					/act/process-editor/modeler.jsp?modelId=1966f90a436c48d8bdf2dc03d44967a4
					\src\main\webapp\act\process-editor\editor-app\modeler.jsp
					ç¼–è¾‘å™¨JSå…¥å£æ–‡ä»¶:
						\src\main\webapp\act\process-editor\editor-app\app.js

					ç¼–è¾‘å™¨é…ç½®æ–‡ä»¶:
						\src\main\webapp\act\process-editor\editor-app\app-cfg.js
						\src\main\webapp\act\process-editor\editor-app\editor-config.js
						\src\main\webapp\act\process-editor\editor-app\configuration\url-config.js (é‡ç‚¹)

					ç¼–è¾‘å™¨å·¥å…·æ¡äº‹ä»¶æ–‡ä»¶:
						\src\main\webapp\act\process-editor\editor-app\configuration\toolbar-default-actions.js
							
					ç¼–è¾‘å™¨æµç¨‹é…ç½®é¡¹Jsonæ–‡ä»¶:
						\src\main\resources\stencilset.json
						\src\main\webapp\act\process-editor\editor-app\editor\oryx.js
						\src\main\webapp\act\process-editor\editor-app\editor\oryx.debug.js
		
		bã€ç›®å½•è¯¦è§£ï¼š
			åå°ï¼š
				æµç¨‹ç›®å½•:
					src\main\java\com\oseasy\initiate\modules\act
					\src\main\java\com\oseasy\initiate\modules\act\web\ActModelController.java
					åˆ›å»ºæµç¨‹æ¨¡å‹ï¼š
						public void create(String name, String key, String description, String category, HttpServletRequest request, HttpServletResponse response)
							org.activiti.engine.repository.Model modelData = actModelService.create(name, key, description, category);
							response.sendRedirect(request.getContextPath() + "/act/process-editor/modeler.jsp?modelId=" + modelData.getId());
								è°ƒç”¨repositoryService.saveModel(modelData) 
									è¡¨act_ge_bytearrayåˆ›å»ºè®°å½•
										INSERT INTO `creativecloud-flow`.`act_ge_bytearray` (`ID_`, `REV_`, `NAME_`, `DEPLOYMENT_ID_`, `BYTES_`, `GENERATED_`) VALUES ('78106793abd24914b71d288bb9f07524', '2', 'source', NULL, '{\"resourceId\":\"1966f90a436c48d8bdf2dc03d44967a4\",\"properties\":{\"process_id\":\"process\",\"name\":\"\",\"documentation\":\"\",\"process_author\":\"initiate\",\"process_version\":\"\",\"process_namespace\":\"http://www.activiti.org/processdef\",\"executionlisteners\":\"\",\"eventlisteners\":\"\",\"signaldefinitions\":\"\",\"messagedefinitions\":\"\"},\"stencil\":{\"id\":\"BPMNDiagram\"},\"childShapes\":[],\"bounds\":{\"lowerRight\":{\"x\":1200,\"y\":1050},\"upperLeft\":{\"x\":0,\"y\":0}},\"stencilset\":{\"url\":\"stencilsets/bpmn2.0/bpmn2.0.json\",\"namespace\":\"http://b3mn.org/stencilset/bpmn2.0#\"},\"ssextensions\":[]}', NULL);
									è¡¨åˆ›å»ºact_re_modelè®°å½•
										INSERT INTO `creativecloud-flow`.`act_re_model` (`ID_`, `REV_`, `NAME_`, `KEY_`, `CATEGORY_`, `CREATE_TIME_`, `LAST_UPDATE_TIME_`, `VERSION_`, `META_INFO_`, `DEPLOYMENT_ID_`, `EDITOR_SOURCE_VALUE_ID_`, `EDITOR_SOURCE_EXTRA_VALUE_ID_`, `TENANT_ID_`) VALUES ('1966f90a436c48d8bdf2dc03d44967a4', '2', 'å¤§èµ›-chenh', 'dasai-chenh', '1', '2017-05-27 16:28:45', '2017-05-27 16:28:45', '1', '{\"name\":\"å¤§èµ›-chenh\",\"revision\":1,\"description\":\"å¤§èµ›-chenh\"}', NULL, '78106793abd24914b71d288bb9f07524', NULL, '');
					
					\src\main\java\com\oseasy\initiate\modules\act\rest\editor\model\ModelSaveRestResource.java
					ç¼–è¾‘ä¿å­˜æµç¨‹æ¨¡å‹ï¼š
						public void saveModel(@PathVariable String modelId, @RequestBody MultiValueMap<String, String> values)
							repositoryService.saveModel(model);
								è¡¨act_ge_bytearrayåˆ›å»ºè®°å½•
									INSERT INTO `creativecloud-flow`.`act_ge_bytearray` (`ID_`, `REV_`, `NAME_`, `DEPLOYMENT_ID_`, `BYTES_`, `GENERATED_`) VALUES ('cb1651850a414d1aacc214f938f8b6a0', '1', 'source-extra', NULL, 'ï¿½PNG\r\n\Z\n\0\0\0\rIHDR\0\0\02\0\0\02\0\0\0?ï¿½ï¿½\0\0\0 cHRM\0\0z&\0\0ï¿½ï¿½\0\0ï¿½\0\0\0ï¿½ï¿½\0\0u0\0\0ï¿½`\0\0:ï¿½\0\0pï¿½ï¿½Q<\0\0\0gAMA\0\0ï¿½ï¿½|ï¿½Qï¿½\0\0\0sRGB\0ï¿½ï¿½ï¿½\0\0\0bKGD\0ï¿½\0ï¿½\0ï¿½ï¿½ï¿½ï¿½ï¿½\0\0\0	pHYs\0\0ï¿½\0\0ï¿½ï¿½+\0\0\0 IDATxï¿½ï¿½ï¿½\0\0\0ï¿½ ï¿½ï¿½nH@\0\0\0\0\0\0\0\0ï¿½ï¿½\'B\0ï¿½ï¿½ï¿½ï¿½\0\0\0\0IENDï¿½B`ï¿½', NULL);


				æµç¨‹Restæ¥å£ç›®å½•:
					src\main\java\com\oseasy\initiate\modules\act\rest
					ç¼–è¾‘å™¨Modelèµ„æºç±»:
						\src\main\java\com\oseasy\initiate\modules\act\rest\editor\model\ModelEditorJsonRestResource.java
							/act/service/model/{modelId}/json
						\src\main\java\com\oseasy\initiate\modules\act\rest\editor\model\ModelSaveRestResource.java
							/act/service/model/{modelId}/save
						\src\main\java\com\oseasy\initiate\modules\act\rest\editor\main\StencilsetRestResource.java
							/act/service/editor/stencilset
			å‰å°ï¼š
				æµç¨‹ç¼–è¾‘å™¨ç›®å½•:
					src\main\webapp\act\process-editor\editor-app
				æµç¨‹ç¼–è¾‘å™¨å…¥å£æ–‡ä»¶:
					act/process-editor/modeler.jsp?modelId=1966f90a436c48d8bdf2dc03d44967a4
					src\main\webapp\act\process-editor\editor-app\modeler.jsp
					ç¼–è¾‘å™¨JSå…¥å£æ–‡ä»¶:
						src\main\webapp\act\process-editor\editor-app\app.js
							æ‰§è¡ŒfetchModel(modelId)æ–¹æ³•ajaxè¯·æ±‚/act/service/model/${modelId}/jsonåœ°å€
							/act/service/model/1966f90a436c48d8bdf2dc03d44967a4/json ç»“æœæ ¼å¼:
								{"name":"å¤§èµ›-chenh","revision":1,"description":"å¤§èµ›-chenh","modelId":"1966f90a436c48d8bdf2dc03d44967a4","model":{"id":"canvas","resourceId":"canvas","properties":{"process_author":"initiate"},"stencilset":{"namespace":"http://b3mn.org/stencilset/bpmn2.0#"}}}

							/act/service/model/1966f90a436c48d8bdf2dc03d44967a4/save å‚æ•°æ ¼å¼ï¼š
							æ ¼å¼è¯´æ˜ï¼š
								name åç§°
								description æè¿°
								json_xml ç”Ÿæˆxmlæ–‡ä»¶é…ç½®
									ModelSaveRestResourceç±»æºç ï¼š
										repositoryService.addModelEditorSource(model.getId(), values.getFirst("json_xml").getBytes("utf-8"));
								svg_xml ç”Ÿæˆæµç¨‹å›¾é…ç½®
									ModelSaveRestResourceç±»æºç ï¼š
										InputStream svgStream = new ByteArrayInputStream(values.getFirst("svg_xml").getBytes("utf-8"));
										TranscoderInput input = new TranscoderInput(svgStream);
										PNGTranscoder transcoder = new PNGTranscoder();
										// Setup output
										ByteArrayOutputStream outStream = new ByteArrayOutputStream();
										TranscoderOutput output = new TranscoderOutput(outStream);
										// Do the transformation
										transcoder.transcode(input, output);

							åŸºæœ¬æ ¼å¼ï¼š
								json_xml={"resourceId":"1966f90a436c48d8bdf2dc03d44967a4","properties":{"process_id":"process","name":"","documentation":"","process_author":"initiate","process_version":"","process_namespace":"http://www.activiti.org/processdef","executionlisteners":"","eventlisteners":"","signaldefinitions":"","messagedefinitions":""},"stencil":{"id":"BPMNDiagram"},"childShapes":[],"bounds":{"lowerRight":{"x":1200,"y":1050},"upperLeft":{"x":0,"y":0}},"stencilset":{"url":"stencilsets/bpmn2.0/bpmn2.0.json","namespace":"http://b3mn.org/stencilset/bpmn2.0#"},"ssextensions":[]}
								
								&svg_xml=<svg xmlns="http://www.w3.org/2000/svg" xmlns:oryx="http://oryx-editor.org" id="sid-19A38C99-68B2-4230-A8DD-6DCEFF5E289C" width="50" height="50" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svg="http://www.w3.org/2000/svg"><defs/><svg id="underlay-container"/><g stroke="none" font-family="Verdana, sans-serif" font-size-adjust="none" font-style="normal" font-variant="normal" font-weight="normal" line-heigth="normal" font-size="12"><g class="stencils"><g class="me"/><g class="children"/><g class="edge"/></g><g class="svgcontainer"><g display="none"><rect x="0" y="0" stroke-width="1" stroke="#777777" fill="none" stroke-dasharray="2,2" pointer-events="none"/></g><g display="none"><path stroke-width="1" stroke="silver" fill="none" stroke-dasharray="5,5" pointer-events="none"/></g><g display="none"><path stroke-width="1" stroke="silver" fill="none" stroke-dasharray="5,5" pointer-events="none"/></g><g/></g></g></svg>&name=å¤§èµ›-chenh&description=å¤§èµ›-chenh


					ç¼–è¾‘å™¨é…ç½®æ–‡ä»¶:
						\src\main\webapp\act\process-editor\editor-app\app-cfg.js
						\src\main\webapp\act\process-editor\editor-app\editor-config.js
						\src\main\webapp\act\process-editor\editor-app\configuration\url-config.js (é‡ç‚¹)
							KISBPM.URL.getModel(modelId);
							KISBPM.URL.putModel(modelMetaData.modelId)})

					ç¼–è¾‘å™¨å·¥å…·æ¡äº‹ä»¶æ–‡ä»¶:
						\src\main\webapp\act\process-editor\editor-app\configuration\toolbar-default-actions.js
							å½“ç‚¹å‡»ä¿å­˜æ—¶æäº¤äº†paramså‚æ•°ï¼ˆ375ï¼‰ï¼š
								var params = {
						            json_xml: json,
						            svg_xml: svgDOM,
						            name: $scope.saveDialog.name,
						            description: $scope.saveDialog.description
						        };

						        jsonï¼ˆ350ï¼‰ï¼š
						        	var json = $scope.editor.getJSON();
							        json = JSON.stringify(json);

        						svgDOMï¼ˆ373ï¼‰ï¼š
        							var svgDOM = DataManager.serialize(svgClone);


					ç¼–è¾‘å™¨æµç¨‹é…ç½®é¡¹Jsonæ–‡ä»¶:
						\src\main\resources\stencilset.json
						\src\main\webapp\act\process-editor\editor-app\editor\oryx.js
						\src\main\webapp\act\process-editor\editor-app\editor\oryx.debug.js
		

	2ã€å·¥ä½œæµæ•´åˆåŸºäºJeesiteé¡¹ç›®ï¼š
		repositoryServiceæœåŠ¡ï¼š
			//ModelEntityManager
			//åˆ›å»ºModel
			Model model = repositoryService.newModel();
			//ä¿®æ”¹Model
			repositoryService.saveModel(model);
			//è·å–Model
			repositoryService.getModel(modelId);

			//å¯¼å‡ºModelåˆ°Xml
			org.activiti.engine.repository.Model modelData = repositoryService.getModel(id);
			BpmnJsonConverter jsonConverter = new BpmnJsonConverter();
			JsonNode editorNode = new ObjectMapper().readTree(repositoryService.getModelEditorSource(modelData.getId()));
			BpmnModel bpmnModel = jsonConverter.convertToBpmnModel(editorNode);
			BpmnXMLConverter xmlConverter = new BpmnXMLConverter();
			byte[] bpmnBytes = xmlConverter.convertToXML(bpmnModel);

			ByteArrayInputStream in = new ByteArrayInputStream(bpmnBytes);
			IOUtils.copy(in, response.getOutputStream());
			String filename = bpmnModel.getMainProcess().getId() + ".bpmn20.xml";
			response.setHeader("Content-Disposition", "attachment; filename=" + filename);
			response.flushBuffer();

	3ã€æ€è·¯æ€»ç»“ï¼š
		æ ¹æ®jsonå»åŠ¨æ€ç”Ÿæˆæµç¨‹æ¨¡å‹éƒ¨ç½²ï¼
			é¡¹ç›®æµç¨‹ç”Ÿæˆåï¼Œç›´æ¥ç”Ÿæˆæµç¨‹æ¨¡å‹ï¼ˆç±»æ¯”ç³»ç»Ÿä¸­çš„åˆ›å»ºæ¨¡å‹åŠŸèƒ½ï¼‰ï¼
			é¡¹ç›®å…³è”æµç¨‹åï¼Œé¡¹ç›®å‘å¸ƒï¼Œç›´æ¥è°ƒç”¨æ¨¡å‹éƒ¨ç½²æµç¨‹ï¼ˆéƒ¨ç½²æ¥å£æŸ¥çœ‹é¡¹ç›®ä¸­æµç¨‹éƒ¨ç½²ï¼‰ï¼

	4ã€æ ¹æ®åŸç”ŸApiå…¥ä¾µå¼åŠ¨æ€ç”Ÿæˆæµç¨‹éƒ¨ç½²ï¼š
		è¯·æŸ¥é˜…ï¼šActivitiå®æˆ˜.pdf-21.1.2åŠ¨æ€åˆ›å»ºæµç¨‹